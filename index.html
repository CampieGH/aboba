<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>–∞–±–æ–±–∞</title>

  <!-- manifest / –∏–∫–æ–Ω–∫–∞ -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="favicon.ico" />

  <!-- ===================  STYLE  =================== -->
  <style>
    /* ===== RESET ===== */
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      font-family: 'Segoe UI', sans-serif;
      background: #121212;
      color: #eaeaea;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      touch-action: manipulation;
      overscroll-behavior: contain;
    }

    /* ===== APP LAYOUT ===== */
    #app      { flex: 1; display: flex; flex-direction: column; min-height: 0; }
    #chatLayout { flex: 1; display: flex; min-height: 0; overflow: hidden; }

    /* ===== SIDEBAR ===== */
    #groupList {
      width: 220px;
      background: #1c1c1c;
      padding: 1em;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #2a2a2a;
    }
    .group-header {
      font-size: 0.9em;
      text-transform: uppercase;
      color: #888;
      margin: 0.5em 0 0.2em;
      letter-spacing: 0.05em;
      user-select: none;
    }
    .group-item {
      padding: 0.6em;
      margin-bottom: 0.4em;
      background: #2a2a2a;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
    }
    .group-item:hover  { background: #3a3a3a; }
    .group-item.active { background: #505050; font-weight: bold; }

    /* ===== CHAT AREA ===== */
    #chatArea { flex: 1; display: flex; flex-direction: column; background: #141414; }
    #groupNameDisplay {
      padding: 1em;
      font-size: 1.2em;
      font-weight: 600;
      border-bottom: 1px solid #2a2a2a;
      user-select: none;
      flex-shrink: 0;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 1em;
      padding-bottom: 90px;
      display: flex;
      flex-direction: column;
      gap: 0.75em;
      scroll-behavior: smooth;
      word-break: break-word;
      white-space: pre-wrap;
    }
    .date-divider {
      text-align: center;
      font-style: italic;
      font-size: 0.9em;
      color: #666;
      margin: 1em 0 0.5em;
      user-select: none;
    }
    .msg { display: flex; gap: 0.75em; align-items: flex-start; }
    .msg.server { justify-content: center; color: #aaa; font-style: italic; }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
      user-select: none;
    }
    .avatar.clickable { cursor: pointer; }

    .content      { flex: 1; }
    .msg-header   { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 2px; }
    .msg-edited   { font-size: 0.8em; font-style: italic; color: #aaa; margin-left: 6px; }

    /* ===== CHAT INPUT ===== */
    #chatInput {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: 60px; background: #1b1b1b; border-top: 1px solid #2a2a2a;
      display: flex; align-items: center; padding: 0 0.5em; z-index: 1000;
    }
    #messageInput {
      flex: 1; resize: none; max-height: 100px; overflow-y: auto;
      padding: 0.6em; border-radius: 4px; background: #2a2a2a;
      color: #fff; border: none; font-size: 16px; outline: none; caret-color: #fff;
    }
    #charCount {
      margin-left: 8px; font-size: 0.8em; color: #888; min-width: 50px; text-align: right;
    }
    #chatInput button {
      margin-left: 0.5em; background: #444; color: #fff;
      padding: 0.6em 1em; border-radius: 4px; border: none;
      font-weight: 600; cursor: pointer; transition: background 0.2s;
    }
    #chatInput button:hover:enabled { background: #555; }
    #chatInput button:disabled      { background: #333; cursor: default; }

    /* ===== PROFILE ICON ===== */
    #profileBtn {
      position: fixed; top: 1em; right: 1em; z-index: 1100;
      width: 44px; height: 44px; border-radius: 50%; font-size: 1.3em;
      background: #2a2a2a; color: #fff; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: background 0.2s;
    }
    #profileBtn:hover { background: #3a3a3a; }

    /* ===== MODALS ===== */
    .modal {
      display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 1200; justify-content: center; align-items: center;
    }
    .modal-content {
      background: #1e1e1e; padding: 20px; border-radius: 12px;
      width: 280px; text-align: center; color: #fff; position: relative;
    }
    .modal-avatar {
      width: 80px; height: 80px; border-radius: 50%;
      background-size: cover; background-position: center; margin: 0 auto 10px;
    }
    .close {
      position: absolute; top: 10px; right: 15px; font-size: 20px; cursor: pointer; color: #aaa;
    }

    /* ===== MOBILE ===== */
    @media (max-width:768px) {
      #groupList {
        width: 100%; height: 50px; flex-direction: row;
        overflow-x: auto; padding: 0.3em 0.6em; border-bottom: 1px solid #2a2a2a; border-right:none;
      }
      .group-item {
        flex: 0 0 auto; margin: 0 0.3em; padding: 0.5em 0.8em; border-radius: 20px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <!-- ===================  DOM  =================== -->
  <div id="app">
    <!-- –ª–æ–≥–∏–Ω -->
    <div id="loginForm" style="display:none;">
      <h2>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</h2>
      <button id="googleLoginBtn">üîê –í–æ–π—Ç–∏</button>
      <p id="loginMsg"></p>
    </div>

    <!-- –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å -->
    <div id="chatLayout">
      <aside id="groupList"></aside>
      <main id="chatArea">
        <div id="groupNameDisplay"></div>
        <div id="messages"></div>
      </main>
    </div>

    <!-- –≤–≤–æ–¥ -->
    <form id="chatInput">
      <textarea id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." rows="1" maxlength="1000"></textarea>
      <div id="charCount">1000</div>
      <button type="submit" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>

    <!-- –∫–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <button id="profileBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è">‚öô</button>

    <!-- –º–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="userProfileModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <span id="closeUserModal" class="close">&times;</span>
        <div class="modal-avatar" id="userModalAvatar"></div>
        <h3 id="userModalNick"></h3>
        <p  id="userModalStatus"></p>
        <button id="userModalMsgBtn">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</button>
      </div>
    </div>

    <!-- –º–æ–¥–∞–ª–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
    <div id="joinGroupModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <span id="closeJoinModal" class="close">&times;</span>
        <h3>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h3>
        <form id="joinGroupForm">
          <input type="text" id="joinGroupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –∏–ª–∏ –Ω–∏–∫" required />
          <input type="text" id="joinGroupCode" placeholder="–ö–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)" />
          <input type="password" id="joinGroupPassword" placeholder="–ü–∞—Ä–æ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å)" />
          <p id="joinGroupError" style="color:#f44336; display:none;"></p>
          <button type="submit">–í–æ–π—Ç–∏</button>
        </form>
      </div>
    </div>

    <!-- –∫–Ω–æ–ø–∫–∞ ¬´–ø–ª—é—Å–∏–∫¬ª -->
    <button id="openJoinModalBtn" style="margin:1em auto; padding:0.6em; border:none; border-radius:6px; background:#333; color:#fff; cursor:pointer;">
      ‚ûï –î–æ–±–∞–≤–∏—Ç—å
    </button>
  </div>

  <!-- ===================  SCRIPT  =================== -->
  <script type="module">
    /* --------------------------------------------------
       Firebase init
    -------------------------------------------------- */
    import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot, addDoc,
      doc, getDoc, setDoc, getDocs, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:            \"AIzaSyC-en4T_Vozvrz7o5dyuYRpZ_4j_ACX3pA\",
      authDomain:        \"abobaserver-49923.firebaseapp.com\",
      projectId:         \"abobaserver-49923\",
      storageBucket:     \"abobaserver-49923.appspot.com\",
      messagingSenderId: \"364642279962\",
      appId:             \"1:364642279962:web:d383373e63e81353d067a3\"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    /* --------------------------------------------------
       DOM refs
    -------------------------------------------------- */
    const loginForm      = document.getElementById(\"loginForm\");
    const googleBtn      = document.getElementById(\"googleLoginBtn\");
    const loginMsg       = document.getElementById(\"loginMsg\");

    const groupList      = document.getElementById(\"groupList\");
    const groupNameLabel = document.getElementById(\"groupNameDisplay\");
    const messagesDiv    = document.getElementById(\"messages\");
    const chatForm       = document.getElementById(\"chatInput\");
    const messageInput   = document.getElementById(\"messageInput\");
    const charCount      = document.getElementById(\"charCount\");

    const joinModal      = document.getElementById(\"joinGroupModal\");
    const openJoinBtn    = document.getElementById(\"openJoinModalBtn\");
    const closeJoinBtn   = document.getElementById(\"closeJoinModal\");
    const joinGroupForm  = document.getElementById(\"joinGroupForm\");
    const joinNameInput  = document.getElementById(\"joinGroupName\");
    const joinErr        = document.getElementById(\"joinGroupError\");

    /* --------------------------------------------------
       state
    -------------------------------------------------- */
    const DEFAULT_AVA = \"https://i.imgur.com/4AiXzf8.png\";
    const DM_PREFIX   = \"__dm__\";        // id –ª–∏—á–µ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —ç—Ç–æ–≥–æ

    let currentUser = null;
    let chats       = [];                 // {id,name,type:'group'|'dm'}
    let selectedId  = null;
    let unsubMsgs   = null;

    const profileCache = {};
    const drafts       = {};

    /* --------------------------------------------------
       helpers
    -------------------------------------------------- */
    const fmtTime = d => d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const fmtDate = d => {
      const n=new Date(), diff=n-d, day=864e5;
      if(diff<day && n.getDate()===d.getDate())        return \"–°–µ–≥–æ–¥–Ω—è\";
      if(diff<2*day && n.getDate()-1===d.getDate())    return \"–í—á–µ—Ä–∞\";
      return d.toLocaleDateString();
    };
    const dmId = (u1,u2)=>`${DM_PREFIX}${[u1,u2].sort().join('_')}`;

    /* --------------------------------------------------
       Auth
    -------------------------------------------------- */
    googleBtn.onclick = ()=> {
      loginMsg.textContent = \"\";
      signInWithPopup(auth,new GoogleAuthProvider()).catch(e=>loginMsg.textContent=\"–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: \"+e.message);
    };
    openJoinBtn.onclick = ()=>{ joinModal.style.display=\"flex\"; joinErr.style.display=\"none\"; };
    closeJoinBtn.onclick= ()=>{ joinModal.style.display=\"none\"; };

    onAuthStateChanged(auth, async user=>{
      currentUser=user;
      if(!user){ resetUI(); return; }

      loginForm.style.display=\"none\";
      await loadChats();
      selectedId = localStorage.getItem(\"selectedChat\") || (chats[0]?.id??null);
      renderSidebar();
      openChat(selectedId);
    });

    /* --------------------------------------------------
       UI
    -------------------------------------------------- */
    function resetUI(){
      loginForm.style.display=\"block\";
      chats.length = 0;
      selectedId   = null;
      messagesDiv.innerHTML = \"\";
      renderSidebar();
      if(unsubMsgs){unsubMsgs();unsubMsgs=null;}
    }

    function renderSidebar(){
      groupList.innerHTML=\"\";
      const groups = chats.filter(c=>c.type!=='dm');
      const dms    = chats.filter(c=>c.type==='dm');

      const addSection=(label,arr)=>{
        const h=document.createElement('div'); h.className='group-header'; h.textContent=label;
        groupList.appendChild(h);
        arr.forEach(c=>{
          const d=document.createElement('div');
          d.className='group-item'+(c.id===selectedId?' active':'');
          d.textContent=c.name;
          d.onclick=()=>{ if(c.id!==selectedId){selectedId=c.id;localStorage.setItem('selectedChat',selectedId);renderSidebar();openChat(c.id);} };
          groupList.appendChild(d);
        });
      };
      addSection('–ì—Ä—É–ø–ø—ã',groups);
      addSection('–õ–∏—á–Ω—ã–µ',dms);
      groupList.appendChild(openJoinBtn);
    }

    /* --------------------------------------------------
       Chats CRUD
    -------------------------------------------------- */
    async function loadChats(){
      chats.length=0;
      const snap=await getDocs(collection(db,'groups'));
      snap.forEach(s=>{
        const d=s.data(); if((d.allowed||[]).includes(auth.currentUser.uid)){
          chats.push({id:s.id,name:d.name||s.id,type:d.type||'group'});
        }
      });
    }

    /* --------------------------------------------------
       Messages
    -------------------------------------------------- */
    async function loadProfile(uid){
      if(!uid) return {};
      if(profileCache[uid]) return profileCache[uid];
      const snap=await getDoc(doc(db,'profiles',uid));
      const data=snap.exists()?snap.data():{};
      profileCache[uid]=data;
      return data;
    }

    async function openChat(id){
      if(unsubMsgs){unsubMsgs();unsubMsgs=null;}
      messagesDiv.innerHTML=\"\";
      const chat=chats.find(c=>c.id===id);
      groupNameLabel.textContent=chat?chat.name:'‚Äî';

      if(!id) return;

      const q=query(collection(db,'groups',id,'messages'),orderBy('createdAt','asc'));
      let lastDate=\"\";
      unsubMsgs=onSnapshot(q,async snap=>{
        messagesDiv.innerHTML=\"\"; lastDate=\"\";
        for(const s of snap.docs){
          const m=s.data(); if(!m.createdAt) continue;
          const d=m.createdAt.toDate(); const ds=fmtDate(d);
          if(ds!==lastDate){ lastDate=ds; const div=document.createElement('div'); div.className='date-divider'; div.textContent=ds; messagesDiv.appendChild(div); }

          const msg=document.createElement('div'); msg.className='msg';
          const ava=document.createElement('div'); ava.className='avatar clickable';
          const prof=await loadProfile(m.uid); ava.style.backgroundImage=`url(${prof.avatar||DEFAULT_AVA})`;
          ava.onclick=()=>openUserModal(m.uid);

          const cont=document.createElement('div'); cont.className='content';
          const head=document.createElement('div'); head.className='msg-header';
          const nickSpan=document.createElement('span'); nickSpan.textContent=prof.nick||'–ë–µ–∑—ã–º—è–Ω–Ω—ã–π'; nickSpan.style.color=prof.color||'#ccc';
          const timeSpan=document.createElement('span'); timeSpan.textContent=fmtTime(d); head.append(nickSpan,timeSpan);
          if(m.edited){const ed=document.createElement('span'); ed.className='msg-edited'; ed.textContent='(—Ä–µ–¥.)'; head.appendChild(ed);}
          const body=document.createElement('div'); body.textContent=m.text||\"\";

          cont.append(head,body); msg.append(ava,cont); messagesDiv.appendChild(msg);
        }
        messagesDiv.scrollTop=messagesDiv.scrollHeight;
      });
    }

    /* --------------------------------------------------
       Send
    -------------------------------------------------- */
    chatForm.addEventListener('submit',async e=>{
      e.preventDefault(); if(!auth.currentUser||!selectedId) return;
      const txt=messageInput.value.trim(); if(!txt) return;
      await addDoc(collection(db,'groups',selectedId,'messages'),{ text:txt, uid:auth.currentUser.uid, createdAt:serverTimestamp(), edited:false });
      messageInput.value=\"\"; charCount.textContent=\"1000\"; drafts[selectedId]=\"\";
    });
    messageInput.addEventListener('input',()=>{
      const len=messageInput.value.length; charCount.textContent=1000-len;
      chatForm.querySelector('button').disabled=!len||len>1000;
      if(selectedId) drafts[selectedId]=messageInput.value;
    });

    /* --------------------------------------------------
       Join / ¬´–ø–ª—é—Å–∏–∫¬ª
    -------------------------------------------------- */
    joinGroupForm.addEventListener('submit',async e=>{
      e.preventDefault(); joinErr.style.display='none';
      const name=joinNameInput.value.trim(); if(!name) return;
      // 1. –∏—â–µ–º –≥—Ä—É–ø–ø—É —Å —Ç–∞–∫–∏–º id
      const snap=await getDoc(doc(db,'groups',name));
      if(snap.exists()){
        await ensureAllowed(name,snap.data()); joinModal.style.display='none'; return;
      }
      // 2. –∏—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–∞–∫–∏–º –Ω–∏–∫–æ–º
      const q=query(collection(db,'profiles'),where('nick','==',name));
      const res=await getDocs(q); if(res.empty){ joinErr.textContent='–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –≥—Ä—É–ø–ø—ã, –Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'; joinErr.style.display='block'; return;}
      const target=res.docs[0]; await openOrCreateDM(target.id,target.data().nick); joinModal.style.display='none';
    });

    async function ensureAllowed(gid,data){
      const allowed=data.allowed||[];
      if(!allowed.includes(auth.currentUser.uid)){
        allowed.push(auth.currentUser.uid);
        await setDoc(doc(db,'groups',gid),{allowed},{merge:true});
      }
      if(!chats.some(c=>c.id===gid)) chats.push({id:gid,name:data.name||gid,type:data.type||'group'});
      selectedId=gid; localStorage.setItem('selectedChat',selectedId); renderSidebar(); openChat(gid);
    }

    /* --------------------------------------------------
       DM creation
    -------------------------------------------------- */
    async function openOrCreateDM(targetUid,targetNick){
      const id=dmId(auth.currentUser.uid,targetUid);
      const ref=doc(db,'groups',id); const snap=await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref,{ name:`–î–∏–∞–ª–æ–≥ —Å ${targetNick}`, type:'dm', allowed:[auth.currentUser.uid,targetUid], createdAt:serverTimestamp() });
      }else{
        const d=snap.data(); const allowed=d.allowed||[]; if(!allowed.includes(auth.currentUser.uid)||!allowed.includes(targetUid)){
          await setDoc(ref,{allowed:[...new Set([...allowed,auth.currentUser.uid,targetUid])]}, {merge:true});
        }
      }
      if(!chats.some(c=>c.id===id)) chats.push({id,name:`–î–∏–∞–ª–æ–≥ —Å ${targetNick}`,type:'dm'});
      selectedId=id; localStorage.setItem('selectedChat',selectedId); renderSidebar(); openChat(id);
    }

    /* --------------------------------------------------
       Profile modal + —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∏–∫–∏
    -------------------------------------------------- */
    async function openUserModal(uid){
      const modal=document.getElementById('userProfileModal');
      const ava  =document.getElementById('userModalAvatar');
      const nick =document.getElementById('userModalNick');
      const stat =document.getElementById('userModalStatus');
      const btn  =document.getElementById('userModalMsgBtn');

      const p=await loadProfile(uid);
      ava.style.backgroundImage=`url(${p.avatar||DEFAULT_AVA})`;
      nick.textContent=p.nick||'–ë–µ–∑—ã–º—è–Ω–Ω—ã–π'; stat.textContent=p.status||'';
      btn.disabled=false; btn.onclick=()=>openOrCreateDM(uid,p.nick||'–ë–µ–∑—ã–º—è–Ω–Ω—ã–π');
      modal.style.display='flex'; modal.onclick=e=>{if(e.target===modal) modal.style.display='none';};
      document.getElementById('closeUserModal').onclick=()=>modal.style.display='none';
    }

    /* —É–Ω–∏–∫ –Ω–∏–∫ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è */
    const profileForm   = document.getElementById('profileForm');
    const profileNick   = document.getElementById('profileNick');
    const profileAvatar = document.getElementById('profileAvatar');
    const profileColor  = document.getElementById('profileColor');
    const profileStatus = document.getElementById('profileStatus');
    const statusCounter = document.getElementById('statusCounter');

    profileStatus.addEventListener('input',()=>statusCounter.textContent=80-profileStatus.value.length);

    profileForm.addEventListener('submit',async e=>{
      e.preventDefault(); if(!auth.currentUser) return;
      let nick=profileNick.value.trim()||'–ë–µ–∑—ã–º—è–Ω–Ω—ã–π';
      const uid=auth.currentUser.uid;

      const clash=await getDocs(query(collection(db,'profiles'),where('nick','==',nick)));
      if(!clash.empty && !clash.docs.find(d=>d.id===uid)){
        let i=1; while(true){
          const candidate=`${nick}_${i}`;
          const q=await getDocs(query(collection(db,'profiles'),where('nick','==',candidate)));
          if(q.empty){ nick=candidate; break; } i++;
        }
      }
      await setDoc(doc(db,'profiles',uid),{
        nick, avatar:profileAvatar.value.trim()||DEFAULT_AVA,
        color:profileColor.value, status:profileStatus.value.trim()
      });
    });

  </script>
</body>
</html>
