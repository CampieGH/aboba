<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>абоба</title>
  <style>
    /* ВСТАВЛЕН CSS, КАК У ТЕБЯ */
  </style>
</head>
<body>
  <!-- ВСТАВЛЕН ВЕСЬ HTML ИЗ ТВОЕЙ ВЕРСТКИ -->
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy,
      onSnapshot, addDoc, serverTimestamp, doc,
      getDoc, setDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider,
      signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

    /*************** 0. Firebase init ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyC-en4T_Vozvrz7o5dyuYRpZ_4j_ACX3pA",
      authDomain: "abobaserver-49923.firebaseapp.com",
      projectId: "abobaserver-49923",
      storageBucket: "abobaserver-49923.appspot.com",
      messagingSenderId: "364642279962",
      appId: "1:364642279962:web:d383373e63e81353d067a3"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    /*************** 1. DOM Elements ***************/
    const $ = id => document.getElementById(id);
    const loginForm = $("loginForm");
    const googleLoginBtn = $("googleLoginBtn");
    const loginMsg = $("loginMsg");
    const appDiv = $("app");
    const chatLayout = $("chatLayout");
    const groupNameDisplay = $("groupNameDisplay");
    const messagesDiv = $("messages");
    const chatInput = $("chatInput");
    const chatInputForm = $("chatInputForm");
    const messageInput = $("messageInput");
    const profileBtn = $("profileBtn");
    const profilePanel = $("profilePanel");
    const logoutBtn = $("logoutBtn");
    const profileForm = $("profileForm");
    const profileNick = $("profileNick");
    const profileAvatar = $("profileAvatar");
    const profileColor = $("profileColor");
    const profileStatus = $("profileStatus");
    const statusCounter = $("statusCounter");
    const userModal = $("userProfileModal");
    const userModalAvatar = $("userModalAvatar");
    const userModalNick = $("userModalNick");
    const userModalStatus = $("userModalStatus");
    const userModalMsgBtn = $("userModalMsgBtn");
    const closeUserModal = $("closeUserModal");
    const privateChatsList = $("privateChatsList");
    const groupList = $("groupList");

    /*************** 2. State ***************/
    let currentUser = null;
    let selectedGroupId = "group1";
    const GROUPS = {
      group1: { name: "Абобики с ДС", mode: "invite" },
      group2: { name: "Дружные абобы", mode: "strict" },
      group3: { name: "aboba global", mode: "open" }
    };

    /*************** 3. Auth Logic ***************/
    onAuthStateChanged(auth, user => {
      if (user) {
        currentUser = user;
        loginForm.style.display = "none";
        chatLayout.style.display = "flex";
        chatInput.style.display = "flex";
        loadMessages();
        updateProfileUI();
      } else {
        loginForm.style.display = "flex";
        chatLayout.style.display = "none";
        chatInput.style.display = "none";
      }
    });

    googleLoginBtn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        loginMsg.textContent = "Ошибка входа";
        console.error(e);
      }
    };

    logoutBtn.onclick = () => signOut(auth);

    /*************** 4. Chat Logic ***************/
    async function loadMessages() {
      const messagesRef = collection(db, "groups", selectedGroupId, "messages");
      const q = query(messagesRef, orderBy("timestamp"));
      onSnapshot(q, snap => {
        messagesDiv.innerHTML = "";
        snap.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = "msg";
          div.innerHTML = `
            <div class="avatar" style="background-image:url(${msg.avatar || ''})"></div>
            <div class="content">
              <div class="msg-header">
                <span>${msg.nick || "anon"}</span>
                <span style="font-size:0.8em;">${new Date(msg.timestamp?.seconds * 1000).toLocaleTimeString()}</span>
              </div>
              <div>${msg.text}</div>
            </div>`;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
      groupNameDisplay.textContent = GROUPS[selectedGroupId]?.name || "Чат";
    }

    chatInputForm.onsubmit = async e => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;
      const profileDoc = await getDoc(doc(db, "users", currentUser.uid));
      const prof = profileDoc.exists() ? profileDoc.data() : {};
      await addDoc(collection(db, "groups", selectedGroupId, "messages"), {
        text,
        uid: currentUser.uid,
        nick: prof.nick || currentUser.displayName || "anon",
        avatar: prof.avatar || currentUser.photoURL || "",
        timestamp: serverTimestamp()
      });
      messageInput.value = "";
    };

    /*************** 5. Profile ***************/
    profileBtn.onclick = () => {
      profilePanel.style.display = profilePanel.style.display === "block" ? "none" : "block";
    };

    profileForm.onsubmit = async e => {
      e.preventDefault();
      await setDoc(doc(db, "users", currentUser.uid), {
        nick: profileNick.value.trim(),
        avatar: profileAvatar.value.trim(),
        color: profileColor.value,
        status: profileStatus.value.trim()
      });
      profilePanel.style.display = "none";
    };

    async function updateProfileUI() {
      const snap = await getDoc(doc(db, "users", currentUser.uid));
      const data = snap.exists() ? snap.data() : {};
      profileNick.value = data.nick || "";
      profileAvatar.value = data.avatar || "";
      profileColor.value = data.color || "#cccccc";
      profileStatus.value = data.status || "";
      statusCounter.textContent = 80 - (data.status?.length || 0);
    }

    profileStatus.oninput = () => {
      const len = profileStatus.value.length;
      statusCounter.textContent = 80 - len;
    };

    /*************** 6. Group Switching ***************/
    groupList.querySelectorAll(".group-item").forEach(el => {
      el.onclick = () => {
        groupList.querySelectorAll(".group-item").forEach(i => i.classList.remove("active"));
        el.classList.add("active");
        selectedGroupId = el.dataset.id;
        loadMessages();
      };
    });

    /*************** 7. Modal Handling ***************/
    closeUserModal.onclick = () => {
      userModal.style.display = "none";
    };
  </script>
</body>
</html>
