<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>–∞–±–æ–±–∞</title>
<style>
*{box-sizing:border-box;}
body,html {
  margin: 0; padding: 0; height: 100%;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #121212;
  color: #eaeaea;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

#loginForm {
  display: none;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 2rem;
  text-align: center;
}
#googleLoginBtn {
  background: #4285f4;
  color: #fff;
  border-radius: 6px;
  padding: 0.75em 1.5em;
  font-weight: 600;
  cursor: pointer;
  user-select: none;
  border: none;
}
#googleLoginBtn:hover {
  background: #357ae8;
}
#loginMsg {
  margin-top: 1em;
  color: #f44336;
}

#chatLayout {
  flex: 1;
  display: flex;
  height: 100%;
  overflow: hidden;
  background: #141414;
}

/* –ì—Ä—É–ø–ø—ã —Å–ª–µ–≤–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ, —Å–≤–µ—Ä—Ö—É –Ω–∞ –º–æ–±–∏–ª–µ */
#groupList {
  background: #1c1c1c;
  border-right: 1px solid #2a2a2a;
  display: flex;
  flex-direction: column;
  padding: 1em;
  overflow-y: auto;
  min-width: 220px;
  max-width: 220px;
  user-select: none;
}

.group-item {
  padding: 0.6em 1em;
  margin-bottom: 0.5em;
  background: #2a2a2a;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
  white-space: nowrap;
}
.group-item:hover {
  background: #3a3a3a;
}
.group-item.active {
  background: #505050;
  font-weight: 700;
  color: #ccc;
}

#chatArea {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
}

#groupNameDisplay {
  padding: 1em;
  font-weight: 600;
  font-size: 1.2em;
  border-bottom: 1px solid #2a2a2a;
  user-select: none;
  background: #181818;
}

#messages {
  flex: 1;
  padding: 1em;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 0.75em;
  scrollbar-width: thin;
  scrollbar-color: #555 #222;
  background: #121212;
}

#messages::-webkit-scrollbar {
  width: 8px;
}
#messages::-webkit-scrollbar-thumb {
  background-color: #555;
  border-radius: 4px;
}

.date-divider {
  text-align: center;
  font-size: 0.85em;
  color: #888;
  margin: 1em 0 0.5em;
  user-select: none;
}

.msg {
  display: flex;
  gap: 0.75em;
}
.msg.server {
  justify-content: center;
  color: #aaa;
  font-style: italic;
  user-select: none;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  flex-shrink: 0;
  cursor: default;
}
.avatar.clickable {
  cursor: pointer;
}

.content {
  flex: 1;
}

.msg-header {
  display: flex;
  justify-content: space-between;
  font-size: 0.9em;
  margin-bottom: 2px;
}

.username {
  font-weight: bold;
  user-select: text;
}

.msg-time {
  color: #999;
  user-select: none;
}

.content > div {
  word-wrap: break-word;
}

#chatInput {
  display: flex;
  border-top: 1px solid #2a2a2a;
  padding: 0.5em 1em;
  background: #1b1b1b;
}

#messageInput {
  flex: 1;
  background: #2a2a2a;
  color: white;
  padding: 0.6em 1em;
  border-radius: 20px;
  border: none;
  font-size: 1rem;
  outline-offset: 0;
}

#messageInput::placeholder {
  color: #aaa;
}

#chatInput button {
  margin-left: 0.75em;
  background: #444;
  color: white;
  padding: 0.6em 1.2em;
  border-radius: 20px;
  cursor: pointer;
  user-select: none;
  font-weight: 600;
  border: none;
  transition: background 0.2s;
}
#chatInput button:hover:not(:disabled) {
  background: #555;
}
#chatInput button:disabled {
  opacity: 0.5;
  cursor: default;
}

#profileBtn {
  position: fixed;
  top: 1rem;
  right: 1rem;
  background: #2a2a2a;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  font-size: 1.4rem;
  color: white;
  cursor: pointer;
  z-index: 20;
  user-select: none;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 8px rgba(0,0,0,0.7);
  transition: background 0.3s;
}
#profileBtn:hover {
  background: #3a3a3a;
}

#profilePanel {
  position: fixed;
  top: 60px;
  right: 1rem;
  background: #1e1e1e;
  border: 1px solid #2a2a2a;
  border-radius: 8px;
  padding: 1em;
  width: 280px;
  display: none;
  z-index: 25;
  box-sizing: border-box;
  user-select: none;
}

#profilePanel input,
#profilePanel textarea,
#profilePanel button {
  width: 100%;
  margin-bottom: 0.6em;
  padding: 0.5em 0.8em;
  border-radius: 6px;
  background: #2d2d2d;
  color: white;
  border: none;
  font-size: 1rem;
  box-sizing: border-box;
  resize: none;
}

#profilePanel textarea {
  min-height: 50px;
}

#profilePanel small {
  text-align: right;
  display: block;
  color: #888;
  user-select: none;
}

#profilePanel button {
  background: #3a3a3a;
  cursor: pointer;
  font-weight: 600;
  transition: background 0.2s;
}
#profilePanel button:hover {
  background: #4a4a4a;
}

.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 12px;
  width: 280px;
  text-align: center;
  position: relative;
  color: white;
  box-sizing: border-box;
}

.modal-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  margin: 0 auto 10px;
  user-select: none;
}

.close {
  position: absolute;
  top: 10px; right: 15px;
  font-size: 22px;
  cursor: pointer;
  color: #aaa;
  user-select: none;
}

#userModalMsgBtn {
  margin-top: 15px;
  padding: 10px 20px;
  border: none;
  background: #333;
  color: #aaa;
  cursor: not-allowed;
  border-radius: 6px;
  user-select: none;
  font-weight: 600;
}

@media (max-width: 768px) {
  #chatLayout {
    flex-direction: column;
  }

  #groupList {
    flex-direction: row;
    min-width: 100%;
    max-width: 100%;
    height: 48px;
    padding: 0 0.5em;
    border-right: none;
    border-bottom: 1px solid #2a2a2a;
    overflow-x: auto;
  }

  .group-item {
    flex: 0 0 auto;
    margin: 0 0.5em;
    padding: 0.4em 1em;
    border-radius: 20px;
    font-size: 0.9em;
    white-space: nowrap;
  }

  #chatArea {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #groupNameDisplay {
    padding: 0.7em 1em;
    font-size: 1.1em;
  }

  #messages {
    flex: 1;
    padding: 0.5em 0.7em;
    overflow-y: auto;
  }

  #chatInput {
    padding: 0.5em 1em;
  }

  #profilePanel {
    top: 55px;
    right: 0.7rem;
    width: 90vw;
  }
}
</style>
</head>
<body>

<div id="app">
  <div id="loginForm" role="main">
    <h2>–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</h2>
    <button id="googleLoginBtn" aria-label="–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google">üîê –í–æ–π—Ç–∏ —Å Google</button>
    <p id="loginMsg" role="alert" aria-live="assertive"></p>
  </div>

  <div id="chatLayout" role="main" aria-live="polite" aria-relevant="additions">
    <aside id="groupList" aria-label="–°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø" role="list"></aside>

    <section id="chatArea" role="region" aria-label="–ß–∞—Ç">
      <header id="groupNameDisplay" aria-live="polite" aria-atomic="true"></header>
      <div id="messages" tabindex="0" aria-live="polite" aria-relevant="additions"></div>

      <form id="chatInput" aria-label="–§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è">
        <input type="text" id="messageInput" aria-label="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." autocomplete="off" required />
        <button type="submit" aria-disabled="false">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </section>
  </div>

  <button id="profileBtn" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è">‚öô</button>

  <div id="profilePanel" role="dialog" aria-modal="true" aria-labelledby="profileFormLabel" tabindex="-1">
    <form id="profileForm">
      <label id="profileFormLabel" hidden>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</label>
      <input id="profileNick" placeholder="–ù–∏–∫" autocomplete="off" aria-label="–ù–∏–∫" />
      <input id="profileAvatar" placeholder="–ê–≤–∞—Ç–∞—Ä URL" autocomplete="off" aria-label="–ê–≤–∞—Ç–∞—Ä URL" />
      <input type="color" id="profileColor" title="–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç –Ω–∏–∫–∞" aria-label="–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç –Ω–∏–∫–∞" />
      <textarea id="profileStatus" maxlength="80" placeholder="–°—Ç–∞—Ç—É—Å" aria-label="–°—Ç–∞—Ç—É—Å"></textarea>
      <small id="statusCounter" aria-live="polite" aria-atomic="true">80</small>
      <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button" id="logoutBtn">–í—ã–π—Ç–∏</button>
    </form>
  </div>
</div>

<div id="userProfileModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="userModalNick" tabindex="-1">
  <div class="modal-content">
    <button id="closeUserModal" class="close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è">&times;</button>
    <div class="modal-avatar" id="userModalAvatar"></div>
    <h3 id="userModalNick">–ò–º—è</h3>
    <p id="userModalStatus">–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
    <button id="userModalMsgBtn" disabled>üí¨ –ù–∞–ø–∏—Å–∞—Ç—å (–ø–æ–∑–∂–µ)</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import {
  getFirestore, collection, query, orderBy,
  onSnapshot, addDoc, serverTimestamp, doc,
  getDoc, setDoc,
  getDocs  // <--- –≤–æ—Ç –µ–≥–æ –Ω–µ –±—ã–ª–æ, –∞ –Ω–∞–¥–æ
} from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import {
  getAuth, signInWithPopup, GoogleAuthProvider,
  signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC-en4T_Vozvrz7o5dyuYRpZ_4j_ACX3pA",
  authDomain: "abobaserver-49923.firebaseapp.com",
  projectId: "abobaserver-49923",
  storageBucket: "abobaserver-49923.appspot.com",
  messagingSenderId: "364642279962",
  appId: "1:364642279962:web:d383373e63e81353d067a3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const loginForm = document.getElementById("loginForm");
const googleLoginBtn = document.getElementById("googleLoginBtn");
const loginMsg = document.getElementById("loginMsg");
const chatLayout = document.getElementById("chatLayout");
const groupList = document.getElementById("groupList");
const groupNameDisplay = document.getElementById("groupNameDisplay");
const messagesDiv = document.getElementById("messages");
const chatInputForm = document.getElementById("chatInput");
const messageInput = document.getElementById("messageInput");
const profileBtn = document.getElementById("profileBtn");
const profilePanel = document.getElementById("profilePanel");
const profileForm = document.getElementById("profileForm");
const profileNick = document.getElementById("profileNick");
const profileAvatar = document.getElementById("profileAvatar");
const profileColor = document.getElementById("profileColor");
const profileStatus = document.getElementById("profileStatus");
const statusCounter = document.getElementById("statusCounter");
const logoutBtn = document.getElementById("logoutBtn");

const userProfileModal = document.getElementById("userProfileModal");
const closeUserModalBtn = document.getElementById("closeUserModal");
const userModalAvatar = document.getElementById("userModalAvatar");
const userModalNick = document.getElementById("userModalNick");
const userModalStatus = document.getElementById("userModalStatus");
const userModalMsgBtn = document.getElementById("userModalMsgBtn");

let currentUser = null;
let groups = [];
let selectedGroup = null;
let unsubscribe = null;
const profilesCache = {};

function formatTime(date) {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatDate(date) {
  const now = new Date();
  const diff = now - date;
  const oneDay = 24 * 60 * 60 * 1000;

  if (diff < oneDay && now.getDate() === date.getDate()) return "–°–µ–≥–æ–¥–Ω—è";
  if (diff < 2 * oneDay && now.getDate() - 1 === date.getDate()) return "–í—á–µ—Ä–∞";

  return date.toLocaleDateString();
}

async function loadProfile(uid) {
  if (profilesCache[uid]) return profilesCache[uid];
  try {
    const snap = await getDoc(doc(db, "profiles", uid));
    if (snap.exists()) {
      profilesCache[uid] = snap.data();
      return profilesCache[uid];
    }
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", e);
  }
  return {
    nick: "–ë–µ–∑—ã–º—è–Ω–Ω—ã–π",
    avatar: "https://i.imgur.com/4AiXzf8.png",
    color: "#ccc",
    status: ""
  };
}

async function openUserModal(uid) {
  const profile = await loadProfile(uid);
  userModalAvatar.style.backgroundImage = url(${profile.avatar || 'https://i.imgur.com/4AiXzf8.png'});
  userModalNick.textContent = profile.nick || "–ë–µ–∑—ã–º—è–Ω–Ω—ã–π";
  userModalNick.style.color = profile.color || "#ccc";
  userModalStatus.textContent = profile.status || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ —Å—Ç–∞—Ç—É—Å–∞";
  userModalMsgBtn.disabled = true;
  userProfileModal.style.display = "flex";
  userProfileModal.setAttribute("aria-hidden", "false");
  userProfileModal.focus();
}

closeUserModalBtn.onclick = () => {
  userProfileModal.style.display = "none";
  userProfileModal.setAttribute("aria-hidden", "true");
};

userProfileModal.onclick = e => {
  if (e.target === userProfileModal) {
    userProfileModal.style.display = "none";
    userProfileModal.setAttribute("aria-hidden", "true");
  }
};

logoutBtn.onclick = () => {
  signOut(auth);
};

profileStatus.addEventListener("input", () => {
  const remaining = 80 - profileStatus.value.length;
  statusCounter.textContent = remaining;
});

profileForm.onsubmit = async e => {
  e.preventDefault();
  if (!currentUser) return;

  const newProfile = {
    nick: profileNick.value.trim() || "–ë–µ–∑—ã–º—è–Ω–Ω—ã–π",
    avatar: profileAvatar.value.trim() || "https://i.imgur.com/4AiXzf8.png",
    color: profileColor.value || "#cccccc",
    status: profileStatus.value.trim()
  };

  try {
    await setDoc(doc(db, "profiles", currentUser.uid), newProfile);
    profilesCache[currentUser.uid] = newProfile;
    alert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
    profilePanel.style.display = "none";
  } catch (e) {
    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: " + e.message);
  }
};

function renderGroups() {
  groupList.innerHTML = "";
  groups.forEach(g => {
    const el = document.createElement('div');
    el.className = 'group-item' + (g.id === selectedGroup ? ' active' : '');
    el.textContent = g.name;
    el.onclick = () => {
      selectedGroup = g.id;
      startChat();
      renderGroups();
    };
    groupList.appendChild(el);
  });
}

function unsubscribeChat() {
  if (unsubscribe) {
    unsubscribe();
    unsubscribe = null;
  }
}

async function startChat() {
  if (!selectedGroup) return;
  messagesDiv.innerHTML = "";

  const q = query(collection(db, "groups", selectedGroup, "messages"), orderBy("createdAt"));

  unsubscribeChat();

  unsubscribe = onSnapshot(q, async snap => {
    messagesDiv.innerHTML = "";
    let lastDate = "";

    for (const docSnap of snap.docs) {
      const m = docSnap.data();
      const date = m.createdAt?.toDate?.() || new Date();
      const dateStr = date.toDateString();

      if (dateStr !== lastDate) {
        const d = document.createElement('div');
        d.className = 'date-divider';
        d.innerText = formatDate(date);
        messagesDiv.appendChild(d);
        lastDate = dateStr;
      }

      if (m.type === 'server') {
        const serverMsg = document.createElement('div');
        serverMsg.className = 'msg server';
        serverMsg.textContent = m.text;
        messagesDiv.appendChild(serverMsg);
        continue;
      }

      const profile = await loadProfile(m.uid);

      const msgDiv = document.createElement('div');
      msgDiv.className = 'msg';

      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'avatar';
      avatarDiv.style.backgroundImage = url(${profile.avatar || 'https://i.imgur.com/4AiXzf8.png'});

      if (m.type === 'user') {
        avatarDiv.classList.add('clickable');
        avatarDiv.onclick = () => openUserModal(m.uid);
      }

      const contentDiv = document.createElement('div');
      contentDiv.className = 'content';

      let headerHTML = "";
      if (m.type === 'user') {
        headerHTML = 
          <div class="msg-header">
            <span class="username" style="color:${profile.color}">${profile.nick}</span>
            <span class="msg-time">${formatTime(date)}</span>
          </div>;
      }

      contentDiv.innerHTML = headerHTML + <div>${m.text}</div>;

      msgDiv.appendChild(avatarDiv);
      msgDiv.appendChild(contentDiv);

      messagesDiv.appendChild(msgDiv);
    }

    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

async function addSystemMessage(text) {
  if (!selectedGroup) return;
  try {
    await addDoc(collection(db, "groups", selectedGroup, "messages"), {
      uid: 'system',
      text,
      createdAt: serverTimestamp(),
      type: 'server'
    });
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
  }
}

chatInputForm.onsubmit = async e => {
  e.preventDefault();
  if (!currentUser) return;

  const text = messageInput.value.trim();
  if (!text) return;

  const msgData = {
    uid: currentUser.uid,
    text,
    createdAt: serverTimestamp(),
    type: "user"
  };

  try {
    await addDoc(collection(db, "groups", selectedGroup, "messages"), msgData);
    messageInput.value = "";
  } catch (e) {
    alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + e.message);
  }
};

profileBtn.onclick = () => {
  profilePanel.style.display = profilePanel.style.display === "block" ? "none" : "block";
};

document.addEventListener('click', e => {
  if (!profilePanel.contains(e.target) && e.target !== profileBtn) {
    profilePanel.style.display = "none";
  }
});

googleLoginBtn.onclick = async () => {
  loginMsg.textContent = "";
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
  } catch (e) {
    loginMsg.textContent = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message;
  }
};

onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user) {
    loginForm.style.display = "none";
    chatLayout.style.display = "flex";
    loadGroups();
    loadProfileToForm();
  } else {
    loginForm.style.display = "flex";
    chatLayout.style.display = "none";
  }
});

async function loadGroups() {
  const groupsCol = collection(db, "groups");
  const q = query(groupsCol, orderBy("name"));
  const snap = await getDocs(q);
  groups = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  if (groups.length > 0) {
    selectedGroup = groups[0].id;
  }
  renderGroups();
  startChat();
}

async function loadProfileToForm() {
  if (!currentUser) return;
  const snap = await getDoc(doc(db, "profiles", currentUser.uid));
  if (snap.exists()) {
    const data = snap.data();
    profileNick.value = data.nick || "";
    profileAvatar.value = data.avatar || "";
    profileColor.value = data.color || "#cccccc";
    profileStatus.value = data.status || "";
    statusCounter.textContent = 80 - profileStatus.value.length;
  } else {
    profileNick.value = "";
    profileAvatar.value = "";
    profileColor.value = "#cccccc";
    profileStatus.value = "";
    statusCounter.textContent = "80";
  }
}
</script>
</body>
</html>
