<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>абоба</title>
  <style>
    /* ===== RESET ===== */
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;height:100%;display:flex;flex-direction:column;font-family:'Segoe UI',sans-serif;background:#121212;color:#eaeaea;-webkit-overflow-scrolling:touch;}

    /* ===== LAYOUT ROOT ===== */
    #app{flex:1;display:flex;flex-direction:column;min-height:0;}
    #chatLayout{flex:1;display:flex;min-height:0;overflow:hidden;}

    /* ===== LOGIN ===== */
    #loginForm{flex:1;display:none;flex-direction:column;justify-content:center;align-items:center;padding:2em;}
    #googleLoginBtn{background:#4285f4;color:#fff;padding:0.6em 1.2em;border-radius:5px;cursor:pointer;font-weight:600;}
    #googleLoginBtn:hover{background:#357ae8;}
    #loginMsg{margin-top:1em;color:#f44336;}

    /* ===== GROUP LIST ===== */
    #groupList{width:220px;background:#1c1c1c;padding:1em;overflow-y:auto;display:flex;flex-direction:column;border-right:1px solid #2a2a2a;}
    .group-section-title { color: #aaa; font-size: 0.9em; margin: 0.8em 0 0.3em 0; }
    .group-item{padding:0.6em;margin-bottom:0.4em;background:#2a2a2a;border-radius:5px;cursor:pointer;user-select:none;}
    .group-item:hover{background:#3a3a3a;}
    .group-item.active{background:#505050;font-weight:bold;}

    /* ===== CHAT AREA ===== */
    #chatArea{flex:1;display:flex;flex-direction:column;min-height:0;background:#141414;}
    #groupNameDisplay{padding:1em;font-size:1.2em;font-weight:600;border-bottom:1px solid #2a2a2a;flex-shrink:0;}

    /* ===== MESSAGES ===== */
    #messages{flex:1;min-height:0;overflow-y:auto;display:flex;flex-direction:column;gap:0.75em;padding:1em;padding-bottom:90px;/* место под поле ввода */}
    .msg{display:flex;gap:0.75em;}
    .msg.server{justify-content:center;color:#aaa;font-style:italic;}
    .avatar{width:36px;height:36px;border-radius:50%;background-size:cover;background-position:center;flex-shrink:0;}
    .content{flex:1;}
    .msg-header{display:flex;justify-content:space-between;font-size:0.9em;margin-bottom:2px;}

    /* ===== CHAT INPUT (fixed) ===== */
    #chatInput{position:fixed;bottom:0;left:0;right:0;height:60px;display:flex;align-items:center;padding:0 0.5em;background:#1b1b1b;border-top:1px solid #2a2a2a;z-index:1000;}
    #messageInput{flex:1;padding:0.6em;border-radius:4px;background:#2a2a2a;color:#fff;border:none;}
    #chatInput button{margin-left:0.5em;background:#444;color:#fff;padding:0.6em 1em;border-radius:4px;cursor:pointer;font-weight:600;border:none;}
    #chatInput button:hover{background:#555;}

    /* ===== PROFILE BUTTON ===== */
    #profileBtn{position:fixed;top:1em;right:1em;background:#2a2a2a;border-radius:50%;width:44px;height:44px;font-size:1.3em;color:#fff;cursor:pointer;z-index:1100;display:flex;align-items:center;justify-content:center;}

    /* ===== PROFILE PANEL ===== */
    #profilePanel{position:fixed;top:60px;right:1em;background:#1e1e1e;border:1px solid #2a2a2a;border-radius:8px;padding:1em;width:260px;display:none;z-index:1050;}
    #profilePanel input,#profilePanel textarea,#profilePanel button{width:100%;margin-bottom:0.6em;padding:0.5em;border-radius:4px;background:#2d2d2d;color:#fff;border:none;}
    #profilePanel textarea{resize:none;min-height:50px;}
    #profilePanel small{display:block;text-align:right;color:#888;}

    /* ===== MODAL ===== */
    .modal{display:none;position:fixed;z-index:1200;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
    .modal-content{background:#1e1e1e;padding:20px;border-radius:12px;width:280px;text-align:center;color:#fff;position:relative;}
    .modal-avatar{width:80px;height:80px;border-radius:50%;background-size:cover;background-position:center;margin:0 auto 10px;}
    .close{position:absolute;top:10px;right:15px;font-size:20px;cursor:pointer;color:#aaa;}

    /* ===== MOBILE ===== */
    @media(max-width:768px){
      #groupList{width:100%;height:50px;flex-direction:row;overflow-x:auto;padding:0.3em 0.6em;border-bottom:1px solid #2a2a2a;border-right:none;}
      .group-section-title { display: none; }
      .group-item{flex:0 0 auto;margin:0 0.3em;padding:0.5em 0.8em;border-radius:20px;font-size:0.9em;}
      #chatLayout{flex-direction:column;}
      #messages{padding:0.5em 1em;padding-bottom:90px;}
      #chatInput{padding:0 0.5em;}
      #profilePanel{right:5vw;width:90vw;}
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="loginForm">
      <div id="googleLoginBtn">Войти через Google</div>
      <div id="loginMsg"></div>
    </div>

    <div id="chatLayout" style="display: none">
      <div id="groupList">
        <div class="group-section-title">Группы</div>
        <div class="group-item" data-id="group1">Абобики с ДС</div>
        <div class="group-item" data-id="group2">Дружные абобы</div>
        <div class="group-item" data-id="group3">aboba global</div>
        <div class="group-section-title">ЛС</div>
        <div id="privateChatsList"></div>
      </div>
      <div id="chatArea">
        <div id="groupNameDisplay"></div>
        <div id="messages"></div>
      </div>
    </div>

    <div id="chatInput" style="display: none">
      <form id="chatInputForm" style="flex: 1; display: flex;">
        <input id="messageInput" type="text" placeholder="Введите сообщение..." autocomplete="off" />
        <button type="submit">Отправить</button>
      </form>
    </div>

    <div id="profileBtn">⚙️</div>
    <div id="profilePanel">
      <form id="profileForm">
        <input id="profileNick" placeholder="Никнейм" />
        <input id="profileAvatar" placeholder="Ссылка на аватар" />
        <input id="profileColor" type="color" value="#cccccc" />
        <textarea id="profileStatus" maxlength="80" placeholder="Статус..."></textarea>
        <small><span id="statusCounter">80</span> символов осталось</small>
        <button type="submit">Сохранить</button>
      </form>
      <button id="logoutBtn">Выйти</button>
    </div>

    <div id="userProfileModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <span id="closeUserModal" class="close">×</span>
        <div id="userModalAvatar" class="modal-avatar"></div>
        <div id="userModalNick"></div>
        <div id="userModalStatus"></div>
        <button id="userModalMsgBtn" disabled>Написать в ЛС</button>
      </div>
    </div>
  </div>


<script type="module">
// main.js – версия с режимами групп (open / invite / strict) + ЛС

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import {
  getFirestore, collection, query, orderBy,
  onSnapshot, addDoc, serverTimestamp, doc,
  getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import {
  getAuth, signInWithPopup, GoogleAuthProvider,
  signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

/********************
 * 0. Firebase init *
 ********************/
const firebaseConfig = {
  apiKey: "AIzaSyC-en4T_Vozvrz7o5dyuYRpZ_4j_ACX3pA",
  authDomain: "abobaserver-49923.firebaseapp.com",
  projectId: "abobaserver-49923",
  storageBucket: "abobaserver-49923.appspot.com",
  messagingSenderId: "364642279962",
  appId: "1:364642279962:web:d383373e63e81353d067a3"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

/********************
 * 1. DOM shortcuts *
 ********************/
const $ = id => document.getElementById(id);
const loginForm=$("loginForm"),googleLoginBtn=$("googleLoginBtn"),loginMsg=$("loginMsg"),chatLayout=$("chatLayout"),groupList=$("groupList"),groupName=$("groupNameDisplay"),messagesDiv=$("messages"),chatInput=$("chatInput"),chatInputForm=$("chatInputForm"),messageInput=$("messageInput"),profileBtn=$("profileBtn"),profilePanel=$("profilePanel"),profileForm=$("profileForm"),profileNick=$("profileNick"),profileAvatar=$("profileAvatar"),profileColor=$("profileColor"),profileStatus=$("profileStatus"),statusCounter=$("statusCounter"),logoutBtn=$("logoutBtn"),userModal=$("userProfileModal"),closeUserModal=$("closeUserModal"),userModalAvatar=$("userModalAvatar"),userModalNick=$("userModalNick"),userModalStatus=$("userModalStatus"),userModalMsgBtn=$("userModalMsgBtn"),privateChatsList=$("privateChatsList");

/********************
 * 2. Static groups *
 ********************/
const GROUP_DEFS = {
  group1:{name:"Абобики с ДС",  mode:"invite"},
  group2:{name:"Дружные абобы", mode:"strict"},
  group3:{name:"aboba global",  mode:"open"}
};
const groupIds = Object.keys(GROUP_DEFS);
let selectedGroupId="group1";
let privateUid="";
let currentUser=null,unsubscribe=null;
const profileCache={};

/********************
 * 3. Helpers        *
 ********************/
const fmtTime=d=>d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
const fmtDate=d=>{const n=new Date(),day=864e5;if(n-d<day&&n.getDate()==d.getDate())return"Сегодня";if(n-d<2*day&&n.getDate()-1==d.getDate())return"Вчера";return d.toLocaleDateString();};
const chatIdFor=(a,b)=>[a,b].sort().join("_");

/********************
 * 4. Auth           *
 ********************/
googleLoginBtn.onclick=()=>{loginMsg.textContent="";signInWithPopup(auth,new GoogleAuthProvider()).catch(e=>loginMsg.textContent="Ошибка: "+e.message);};
logoutBtn.onclick=()=>{unsubscribe?.();signOut(auth);};

onAuthStateChanged(auth,async user=>{
  currentUser=user;
  if(user){
    loginForm.style.display="none";chatLayout.style.display="flex";chatInput.style.display="flex";profileBtn.style.display="flex";
    await loadOwnProfile();
    renderSidebar();
    openGroup(selectedGroupId);
  }else{
    loginForm.style.display="flex";chatLayout.style.display="none";chatInput.style.display="none";profileBtn.style.display="none";unsubscribe?.();
  }
});

async function loadOwnProfile(){
  if(!currentUser)return;const snap=await getDoc(doc(db,"profiles",currentUser.uid));if(snap.exists())profileCache[currentUser.uid]=snap.data();
  const p=profileCache[currentUser.uid]||{};profileNick.value=p.nick||"";profileAvatar.value=p.avatar||"";profileColor.value=p.color||"#cccccc";profileStatus.value=p.status||"";statusCounter.textContent=80-(profileStatus.value.length||0);
}

/********************
 * 5. Sidebar render *
 ********************/
function renderSidebar(){
  groupList.querySelectorAll(".group-item").forEach(el=>el.remove());
  privateChatsList.innerHTML="";
  Object.entries(profileCache).forEach(([uid,p])=>{ if(uid===currentUser.uid) return; const el=document.createElement("div"); el.className="group-item"+(uid===privateUid?" active":""); el.textContent=p.nick||"Безымянный"; el.onclick=()=>openPrivate(uid); privateChatsList.appendChild(el); });
  groupIds.forEach(id=>{const meta=GROUP_DEFS[id];const el=document.createElement("div");el.className="group-item"+(id===selectedGroupId&&!privateUid?" active":"");el.dataset.id=id;el.textContent=meta.name;el.onclick=()=>openGroup(id);groupList.appendChild(el);});
}

/********************
 * 6. Chat opening   *
 ********************/
function openGroup(id){privateUid="";selectedGroupId=id;chatInputForm.dataset.chatType="group";chatInputForm.dataset.group=id;groupName.textContent=GROUP_DEFS[id].name;messagesDiv.innerHTML="";unsubscribe?.();const q=query(collection(db,"groups",id,"messages"),orderBy("createdAt"));unsubscribe=onSnapshot(q,renderSnap);updateInputLock();renderSidebar();}
function openPrivate(uid){selectedGroupId="";privateUid=uid;chatInputForm.dataset.chatType="private";chatInputForm.dataset.targetUid=uid;loadProfile(uid).then(p=>groupName.textContent="Диалог с "+(p.nick||"Безымянный"));messagesDiv.innerHTML="";unsubscribe?.();const q=query(collection(db,"privateChats",chatIdFor(currentUser.uid,uid),"messages"),orderBy("createdAt"));unsubscribe=onSnapshot(q,renderSnap);updateInputLock();renderSidebar();}

/********************
 * 7. Access control *
 ********************/
async function updateInputLock(){
  if(chatInputForm.dataset.chatType==="group"){const id=chatInputForm.dataset.group;const docSnap=await getDoc(doc(db,"groups",id));const data=docSnap.exists()?docSnap.data():{mode:GROUP_DEFS[id].mode,members:[],admins:[]};const mode=data.mode||"open";const canWrite=(mode==="open")||(mode==="invite"&&data.members?.includes(currentUser.uid))||(mode==="strict"&&data.admins?.includes(currentUser.uid));messageInput.disabled=!canWrite;chatInputForm.querySelector("button").disabled=!canWrite;}
  else{messageInput.disabled=false;chatInputForm.querySelector("button").disabled=false;}
}

/********************
 * 8. Snapshot → DOM *
 ********************/
function renderSnap(snap){messagesDiv.innerHTML="";let last="";snap.docs.forEach(async d=>{const m=d.data();const dt=m.createdAt?.toDate?.()||new Date();const ds=dt.toDateString();if(ds!==last){const div=document.createElement("div");div.className="date-divider";div.textContent=fmtDate(dt);messagesDiv.appendChild(div);last=ds;}if(m.type==="server"){const s=document.createElement("div");s.className="msg server";s.textContent=m.text;messagesDiv.appendChild(s);return;}const pr=await loadProfile(m.uid);const msg=document.createElement("div");msg.className="msg";const av=document.createElement("div");av.className="avatar";av.style.backgroundImage=`url(${pr.avatar})`;av.onclick=()=>openUserModal(m.uid);const cont=document.createElement("div");cont.className="content";cont.innerHTML=`<div class='msg-header'><span class='username' style='color:${pr.color}'>${pr.nick}</span><span class='msg-time'>${fmtTime(dt)}</span></div><div>${m.text}</div>`;msg.appendChild(av);msg.appendChild(cont);messagesDiv.appendChild(msg);messagesDiv.scrollTop=messagesDiv.scrollHeight;});}

/********************
 * 9. Sending        *
 ********************/
chatInputForm.onsubmit=async e=>{e.preventDefault();const txt=messageInput.value.trim();if(!txt)return;const payload={uid:currentUser.uid,text:txt,createdAt:serverTimestamp(),type:"user"};if(chatInputForm.dataset.chatType==="private"){await addDoc(collection(db,"privateChats",chatIdFor(currentUser.uid,chatInputForm.dataset.targetUid),"messages"),payload);}else{await addDoc(collection(db,"groups",selectedGroupId,"messages"),payload);}messageInput.value="";};

/********************
 * 10. Profiles etc. *
 ********************/
async function loadProfile(uid){if(profileCache[uid])return profileCache[uid];const snap=await getDoc(doc(db,"profiles",uid));const data=snap.exists()?snap.data():{nick:"Безымянный",avatar:"https://i.imgur.com/4AiXzf8.png",color:"#ccc",status:""};profileCache[uid]=data;return data;}

function openUserModal(uid){loadProfile(uid).then(p=>{userModalAvatar.style.backgroundImage=`url(${p.avatar||"https://i.imgur.com/4AiXzf8.png"})`;userModalNick.textContent=p.nick||"Безымянный";userModalNick.style.color=p.color||"#ccc";userModalStatus.textContent=p.status||"";userModal.style.display="flex";userModal.setAttribute("aria-hidden","false");userModalMsgBtn.disabled=true;});}

closeUserModal.onclick=()=>{userModal.style.display="none";userModal.setAttribute("aria-hidden","true");};
userModal.onclick=e=>{if(e.target===userModal){userModal.style.display="none";userModal.setAttribute("aria-hidden","true");}};

profileStatus.oninput=()=>{statusCounter.textContent=80-profileStatus.value.length;};

profileForm.onsubmit=async e=>{e.preventDefault();if(!currentUser)return;const newProfile={nick:profileNick.value.trim()||"Безымянный",avatar:profileAvatar.value.trim()||"https://i.imgur.com/4AiXzf8.png",color:profileColor.value||"#cccccc",status:profileStatus.value.trim()};await setDoc(doc(db,"profiles",currentUser.uid),newProfile);profileCache[currentUser.uid]=newProfile;alert("Профиль обновлён!");};

profileBtn.onclick=()=>{profilePanel.style.display=profilePanel.style.display==="block"?"none":"block";};
document.addEventListener("click",e=>{if(!profilePanel.contains(e.target)&&e.target!==profileBtn)profilePanel.style.display="none";});

</script>
</body>
</html>
