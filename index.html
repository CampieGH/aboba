<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>абоба</title>
  <style>
    /* ===== RESET ===== */
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;height:100%;display:flex;flex-direction:column;font-family:'Segoe UI',sans-serif;background:#121212;color:#eaeaea;-webkit-overflow-scrolling:touch;}
    /* ===== SPLASH SCREEN ===== */
    #splashScreen {
      position: fixed;
      inset: 0;
      background: #121212;
      color: #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-size: 2em;
      font-weight: 600;
      user-select: none;
      z-index: 2000;
      transition: opacity 0.5s ease;
    }
    /* ===== LAYOUT ROOT ===== */
    #app{flex:1;display:flex;flex-direction:column;min-height:0;opacity: 0; transition: opacity 0.5s ease;}
    #chatLayout{flex:1;display:flex;min-height:0;overflow:hidden;}
    /* ===== LOGIN ===== */
    #loginForm{flex:1;display:none;flex-direction:column;justify-content:center;align-items:center;padding:2em;}
    #googleLoginBtn{background:#4285f4;color:#fff;padding:0.6em 1.2em;border-radius:5px;cursor:pointer;font-weight:600;}
    #googleLoginBtn:hover{background:#357ae8;}
    #loginMsg{margin-top:1em;color:#f44336;}
    /* ===== GROUP LIST ===== */
    #groupList{width:220px;background:#1c1c1c;padding:1em;overflow-y:auto;display:flex;flex-direction:column;border-right:1px solid #2a2a2a;}
    .group-section-title { color: #aaa; font-size: 0.9em; margin: 0.8em 0 0.3em 0; }
    .group-item{padding:0.6em;margin-bottom:0.4em;background:#2a2a2a;border-radius:5px;cursor:pointer;user-select:none;}
    .group-item:hover{background:#3a3a3a;}
    .group-item.active{background:#505050;font-weight:bold;}
    #addGroupBtn {
      margin: 0.5em 0 1em 0;
      padding: 0.4em 0.8em;
      border-radius: 5px;
      background: #3a3a3a;
      color: #eee;
      font-weight: 600;
      cursor: pointer;
      user-select:none;
      text-align:center;
    }
    #addGroupBtn:hover {
      background: #505050;
    }
    /* ===== CHAT AREA ===== */
    #chatArea{flex:1;display:flex;flex-direction:column;min-height:0;background:#141414;}
    #groupNameDisplay{padding:1em;font-size:1.2em;font-weight:600;border-bottom:1px solid #2a2a2a;flex-shrink:0;}
    /* ===== MESSAGES ===== */
    #messages{flex:1;min-height:0;overflow-y:auto;display:flex;flex-direction:column;gap:0.75em;padding:1em;padding-bottom:90px;}
    .msg{display:flex;gap:0.75em;word-break: break-word;}
    .msg.server{justify-content:center;color:#aaa;font-style:italic;}
    .avatar{width:36px;height:36px;border-radius:50%;background-size:cover;background-position:center;flex-shrink:0;}
    .content{flex:1;}
    .msg-header{display:flex;justify-content:space-between;font-size:0.9em;margin-bottom:2px;}
    /* ===== CHAT INPUT (fixed) ===== */
    #chatInput{position:fixed;bottom:0;left:0;right:0;height:80px;display:flex;align-items:center;padding:0 0.5em;background:#1b1b1b;border-top:1px solid #2a2a2a;z-index:1000;}
    #chatInputForm{flex:1;display:flex;align-items:center;}
    #messageInput {
      flex:1;
      padding:0.6em;
      border-radius:4px;
      background:#2a2a2a;
      color:#fff;
      border:none;
      resize:none;
      font-size:16px;
      line-height:1.4em;
      max-height:6em;
      overflow-y:auto;
      min-height:36px;
      font-family: 'Segoe UI', sans-serif;
    }
    #chatInput button {
      margin-left:0.5em;
      background:#444;
      color:#fff;
      padding:0.6em 1em;
      border-radius:4px;
      cursor:pointer;
      font-weight:600;
      border:none;
      user-select:none;
      flex-shrink:0;
    }
    #chatInput button:hover{background:#555;}
    /* ===== PROFILE BUTTON ===== */
    #profileBtn{position:fixed;top:1em;right:1em;background:#2a2a2a;border-radius:50%;width:44px;height:44px;font-size:1.3em;color:#fff;cursor:pointer;z-index:1100;display:flex;align-items:center;justify-content:center;}
    /* ===== PROFILE PANEL ===== */
    #profilePanel{position:fixed;top:60px;right:1em;background:#1e1e1e;border:1px solid #2a2a2a;border-radius:8px;padding:1em;width:260px;display:none;z-index:1050;}
    #profilePanel input,#profilePanel textarea,#profilePanel button{width:100%;margin-bottom:0.6em;padding:0.5em;border-radius:4px;background:#2d2d2d;color:#fff;border:none;}
    #profilePanel textarea{resize:none;min-height:50px;}
    #profilePanel small{display:block;text-align:right;color:#888;}
    /* ===== MODAL ===== */
    .modal{display:none;position:fixed;z-index:1200;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
    .modal-content{background:#1e1e1e;padding:20px;border-radius:12px;width:280px;text-align:center;color:#fff;position:relative;}
    .modal-avatar{width:80px;height:80px;border-radius:50%;background-size:cover;background-position:center;margin:0 auto 10px;}
    .close{position:absolute;top:10px;right:15px;font-size:20px;cursor:pointer;color:#aaa;}
    /* ===== MOBILE ===== */
    @media(max-width:768px){
      #groupList{width:100%;height:50px;flex-direction:row;overflow-x:auto;padding:0.3em 0.6em;border-bottom:1px solid #2a2a2a;border-right:none;}
      .group-section-title { display: none; }
      .group-item{flex:0 0 auto;margin:0 0.3em;padding:0.5em 0.8em;border-radius:20px;font-size:0.9em;}
      #chatLayout{flex-direction:column;}
      #messages{padding:0.5em 1em;padding-bottom:90px;}
      #chatInput{padding:0 0.5em;}
      #profilePanel{right:5vw;width:90vw;}
    }
  </style>
</head>
<body>

  <!-- SPLASH SCREEN -->
  <div id="splashScreen">лабобу</div>

  <div id="app" style="opacity:0;">
    <div id="loginForm">
      <div id="googleLoginBtn">Войти через Google</div>
      <div id="loginMsg"></div>
    </div>

    <div id="chatLayout" style="display: none">
      <div id="groupList">
        <div class="group-section-title">Группы</div>
        <div id="addGroupBtn">+ Добавить группу</div>
        <!-- Статические группы -->
        <div class="group-item" data-id="group1">Абобики с ДС</div>
        <div class="group-item" data-id="group2">Дружные абобы</div>
        <div class="group-item" data-id="group3">aboba global</div>
        <div class="group-section-title">ЛС</div>
        <div id="privateChatsList"></div>
      </div>
      <div id="chatArea">
        <div id="groupNameDisplay"></div>
        <div id="messages"></div>
      </div>
    </div>

    <div id="chatInput" style="display: none">
      <form id="chatInputForm" style="flex: 1; display: flex;">
        <textarea id="messageInput" placeholder="Введите сообщение..." autocomplete="off" rows="1"></textarea>
        <button type="submit">Отправить</button>
      </form>
    </div>

    <div id="profileBtn">⚙️</div>
    <div id="profilePanel">
      <form id="profileForm">
        <input id="profileNick" placeholder="Никнейм" />
        <input id="profileAvatar" placeholder="Ссылка на аватар" />
        <input id="profileColor" type="color" value="#cccccc" />
        <textarea id="profileStatus" maxlength="80" placeholder="Статус..."></textarea>
        <small><span id="statusCounter">80</span> символов осталось</small>
        <button type="submit">Сохранить</button>
      </form>
      <button id="logoutBtn">Выйти</button>
    </div>

    <div id="userProfileModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <span id="closeUserModal" class="close">×</span>
        <div id="userModalAvatar" class="modal-avatar"></div>
        <div id="userModalNick"></div>
        <div id="userModalStatus"></div>
        <button id="userModalMsgBtn" disabled>Написать в ЛС</button>
      </div>
    </div>

    <!-- Add Group Modal -->
    <div id="addGroupModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <span id="closeAddGroupModal" class="close">×</span>
        <h3>Добавить группу</h3>
        <input id="newGroupName" placeholder="Название группы" />
        <input id="newGroupPassword" type="password" placeholder="Пароль (опционально)" />
        <button id="createGroupBtn">Создать</button>
      </div>
    </div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import {
  getFirestore, collection, query, orderBy,
  onSnapshot, addDoc, serverTimestamp, doc,
  getDoc, setDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
import {
  getAuth, signInWithPopup, GoogleAuthProvider,
  signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

/********************
 * 0. Firebase init *
 ********************/
const firebaseConfig = {
  apiKey: "AIzaSyC-en4T_Vozvrz7o5dyuYRpZ_4j_ACX3pA",
  authDomain: "abobaserver-49923.firebaseapp.com",
  projectId: "abobaserver-49923",
  storageBucket: "abobaserver-49923.appspot.com",
  messagingSenderId: "364642279962",
  appId: "1:364642279962:web:d383373e63e81353d067a3"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

/********************
 * 1. DOM shortcuts *
 ********************/
const $ = id => document.getElementById(id);
const loginForm=$("loginForm"),googleLoginBtn=$("googleLoginBtn"),loginMsg=$("loginMsg"),chatLayout=$("chatLayout"),groupList=$("groupList"),groupName=$("groupNameDisplay"),messagesDiv=$("messages"),chatInput=$("chatInput"),chatInputForm=$("chatInputForm"),messageInput=$("messageInput"),profileBtn=$("profileBtn"),profilePanel=$("profilePanel"),profileForm=$("profileForm"),profileNick=$("profileNick"),profileAvatar=$("profileAvatar"),profileColor=$("profileColor"),profileStatus=$("profileStatus"),statusCounter=$("statusCounter"),logoutBtn=$("logoutBtn"),userModal=$("userProfileModal"),closeUserModal=$("closeUserModal"),userModalAvatar=$("userModalAvatar"),userModalNick=$("userModalNick"),userModalStatus=$("userModalStatus"),userModalMsgBtn=$("userModalMsgBtn"),privateChatsList=$("privateChatsList"),addGroupBtn=$("addGroupBtn"),addGroupModal=$("addGroupModal"),closeAddGroupModal=$("closeAddGroupModal"),newGroupName=$("newGroupName"),newGroupPassword=$("newGroupPassword"),createGroupBtn=$("createGroupBtn"),splashScreen=$("splashScreen");

/********************
 * 2. Static groups *
 ********************/
const GROUP_DEFS = {
  group1:{name:"Абобики с ДС",  mode:"invite"},
  group2:{name:"Дружные абобы", mode:"strict"},
  group3:{name:"aboba global",  mode:"open"}
};
const groupIds = Object.keys(GROUP_DEFS);
let selectedGroupId="group1";
let privateUid="";
let currentUser=null,unsubscribe=null;
const profileCache={};

/********************
 * 3. Helpers        *
 ********************/
const fmtTime=d=>d.toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
const fmtDate=d=>{
  const n=new Date(),day=864e5;
  if(n-d<day&&n.getDate()==d.getDate())return"Сегодня";
  if(n-d<2*day&&n.getDate()-1==d.getDate())return"Вчера";
  return d.toLocaleDateString();
};
const chatIdFor=(a,b)=>[a,b].sort().join("_");

/********************
 * 4. Auth           *
 ********************/
googleLoginBtn.onclick=()=>{
  loginMsg.textContent="";
  signInWithPopup(auth,new GoogleAuthProvider()).catch(e=>loginMsg.textContent="Ошибка: "+e.message);
};
logoutBtn.onclick=()=>{
  unsubscribe?.();
  signOut(auth);
};

onAuthStateChanged(auth,async user=>{
  currentUser=user;
  if(user){
    loginForm.style.display="none";
    chatLayout.style.display="flex";
    chatInput.style.display="flex";
    profileBtn.style.display="flex";
    await loadOwnProfile();
    await loadAllProfiles();
    renderSidebar();
    openGroup(selectedGroupId);
    splashScreen.style.opacity = "0";
    setTimeout(()=>{
      splashScreen.style.display = "none";
      app.style.opacity = "1";
    }, 600);
  }else{
    loginForm.style.display="flex";
    chatLayout.style.display="none";
    chatInput.style.display="none";
    profileBtn.style.display="none";
    unsubscribe?.();
    splashScreen.style.display = "flex";
    splashScreen.style.opacity = "1";
    app.style.opacity = "0";
  }
});

/********************
 * 5. Load own profile *
 ********************/
async function loadOwnProfile(){
  if(!currentUser)return;
  const snap=await getDoc(doc(db,"profiles",currentUser.uid));
  if(snap.exists())profileCache[currentUser.uid]=snap.data();
  const p=profileCache[currentUser.uid]||{};
  profileNick.value=p.nick||"";
  profileAvatar.value=p.avatar||"";
  profileColor.value=p.color||"#cccccc";
  profileStatus.value=p.status||"";
  statusCounter.textContent=80-(profileStatus.value.length||0);
}

/********************
 * 5.1 Load all profiles to cache *
 ********************/
async function loadAllProfiles(){
  const q= query(collection(db,"profiles"));
  const snap=await getDocs(q);
  snap.docs.forEach(doc=>{
    profileCache[doc.id]=doc.data();
  });
}

/********************
 * 6. Sidebar render *
 ********************/
function renderSidebar(){
  // Удаляем только динамические группы (кроме кнопки)
  [...groupList.querySelectorAll(".group-item")].forEach(el=>{
    if(el.id !== 'addGroupBtn' && !groupIds.includes(el.dataset.id)){
      el.remove();
    }
  });
  privateChatsList.innerHTML="";

  // ЛС
  Object.entries(profileCache).forEach(([uid,p])=>{
    if(uid===currentUser.uid) return;
    const el=document.createElement("div");
    el.className="group-item"+(uid===privateUid?" active":"");
    el.textContent=p.nick||"Безымянный";
    el.onclick=()=>openPrivate(uid);
    privateChatsList.appendChild(el);
  });

  // Группы - добавляем динамически по GROUP_DEFS
  groupIds.forEach(id=>{
    const meta=GROUP_DEFS[id];
    const exists = [...groupList.querySelectorAll(".group-item")].some(el=>el.dataset.id === id);
    if(!exists){
      const el=document.createElement("div");
      el.className="group-item"+(id===selectedGroupId?" active":"");
      el.textContent=meta.name;
      el.dataset.id=id;
      el.onclick=()=>openGroup(id);
      groupList.insertBefore(el, addGroupBtn.nextSibling);
    } else {
      const el = [...groupList.querySelectorAll(".group-item")].find(el=>el.dataset.id === id);
      el.className="group-item"+(id===selectedGroupId?" active":"");
    }
  });
}

/********************
 * 7. Open group chat *
 ********************/
async function openGroup(id){
  unsubscribe?.();
  privateUid="";
  selectedGroupId=id;
  renderSidebar();
  groupName.textContent = GROUP_DEFS[id].name;
  messagesDiv.innerHTML="";
  // Подписка на сообщения группы
  const messagesRef=collection(db,"groups",id,"messages");
  const q=query(messagesRef,orderBy("createdAt"));
  unsubscribe = onSnapshot(q,snap=>{
    messagesDiv.innerHTML="";
    snap.docs.forEach(doc=>{
      renderMessage(doc.data(),doc.id);
    });
    scrollToBottom();
  });
}

/********************
 * 8. Open private chat *
 ********************/
async function openPrivate(uid){
  unsubscribe?.();
  privateUid=uid;
  selectedGroupId="";
  renderSidebar();
  const p = profileCache[uid];
  groupName.textContent = "ЛС: " + (p?.nick||"Безымянный");
  messagesDiv.innerHTML="";
  // Подписка на личку
  const chatId = chatIdFor(currentUser.uid,uid);
  const messagesRef=collection(db,"private",chatId,"messages");
  const q=query(messagesRef,orderBy("createdAt"));
  unsubscribe = onSnapshot(q,snap=>{
    messagesDiv.innerHTML="";
    snap.docs.forEach(doc=>{
      renderMessage(doc.data(),doc.id);
    });
    scrollToBottom();
  });
}

/********************
 * 9. Render message *
 ********************/
function renderMessage(msg,id){
  const el=document.createElement("div");
  el.className="msg";
  if(msg.uid==="server") el.className+=" server";
  else if(msg.uid === currentUser?.uid) el.style.justifyContent = "flex-end";

  if(msg.uid==="server"){
    el.textContent=msg.text;
    messagesDiv.appendChild(el);
    return;
  }

  const avatarDiv=document.createElement("div");
  avatarDiv.className="avatar";
  const p = profileCache[msg.uid];
  avatarDiv.style.backgroundImage = `url(${p?.avatar||''})`;
  avatarDiv.title = p?.nick || "Безымянный";
  avatarDiv.onclick = () => openUserModal(msg.uid);

  const contentDiv=document.createElement("div");
  contentDiv.className="content";

  const headerDiv=document.createElement("div");
  headerDiv.className="msg-header";
  headerDiv.innerHTML = `<span>${p?.nick||"Безымянный"}</span><span>${fmtTime(msg.createdAt?.toDate ? msg.createdAt.toDate() : new Date())}</span>`;

  const textDiv=document.createElement("div");
  textDiv.textContent = msg.text;

  contentDiv.appendChild(headerDiv);
  contentDiv.appendChild(textDiv);

  el.appendChild(avatarDiv);
  el.appendChild(contentDiv);

  messagesDiv.appendChild(el);
}

/********************
 * 10. Scroll chat *
 ********************/
function scrollToBottom(){
  setTimeout(()=>{
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  },100);
}

/********************
 * 11. Send message *
 ********************/
chatInputForm.onsubmit=async e=>{
  e.preventDefault();
  const text=messageInput.value.trim();
  if(!text) return;
  messageInput.value="";
  if(privateUid){
    // личка
    const chatId = chatIdFor(currentUser.uid,privateUid);
    await addDoc(collection(db,"private",chatId,"messages"),{
      uid: currentUser.uid,
      text,
      createdAt: serverTimestamp()
    });
  } else if(selectedGroupId){
    // группа
    await addDoc(collection(db,"groups",selectedGroupId,"messages"),{
      uid: currentUser.uid,
      text,
      createdAt: serverTimestamp()
    });
  }
  scrollToBottom();
};

/********************
 * 12. Shift+Enter for new line
 ********************/
messageInput.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    chatInputForm.requestSubmit();
  }
});

/********************
 * 13. Profile toggle *
 ********************/
profileBtn.onclick=()=>{
  profilePanel.style.display = profilePanel.style.display==="block" ? "none" : "block";
};

profileStatus.oninput=()=>{
  statusCounter.textContent = 80 - profileStatus.value.length;
};

/********************
 * 14. Save profile *
 ********************/
profileForm.onsubmit=async e=>{
  e.preventDefault();
  if(!currentUser) return;
  const nick = profileNick.value.trim();
  if(!nick){
    alert("Никнейм не может быть пустым");
    return;
  }
  // Проверка на уникальность ника (примитивная)
  const existingNicks = Object.values(profileCache).map(p=>p.nick.toLowerCase());
  if(existingNicks.includes(nick.toLowerCase()) && profileCache[currentUser.uid]?.nick?.toLowerCase() !== nick.toLowerCase()){
    alert("Никнейм занят");
    return;
  }
  const data = {
    nick,
    avatar: profileAvatar.value.trim(),
    color: profileColor.value,
    status: profileStatus.value.trim(),
    updatedAt: serverTimestamp()
  };
  await setDoc(doc(db,"profiles",currentUser.uid),data);
  profileCache[currentUser.uid]=data;
  alert("Профиль сохранён");
  profilePanel.style.display="none";
  renderSidebar();
};

/********************
 * 15. User modal *
 ********************/
function openUserModal(uid){
  if(!profileCache[uid]) return;
  const p = profileCache[uid];
  userModalAvatar.style.backgroundImage = `url(${p.avatar||''})`;
  userModalNick.textContent = p.nick || "Безымянный";
  userModalStatus.textContent = p.status || "";
  userModal.style.display = "flex";
  userModal.setAttribute("aria-hidden","false");
  userModalMsgBtn.disabled = (uid === currentUser.uid);
  userModalMsgBtn.onclick = () => {
    openPrivate(uid);
    userModal.style.display = "none";
  }
}
closeUserModal.onclick = () => {
  userModal.style.display = "none";
  userModal.setAttribute("aria-hidden","true");
};

/********************
 * 16. Add group modal *
 ********************/
addGroupBtn.onclick = () => {
  newGroupName.value="";
  newGroupPassword.value="";
  addGroupModal.style.display = "flex";
  addGroupModal.setAttribute("aria-hidden","false");
};
closeAddGroupModal.onclick = () => {
  addGroupModal.style.display = "none";
  addGroupModal.setAttribute("aria-hidden","true");
};
createGroupBtn.onclick = () => {
  const name = newGroupName.value.trim();
  if(!name){
    alert("Название группы не может быть пустым");
    return;
  }
  // Уникальность имени группы
  const exist = Object.values(GROUP_DEFS).some(g=>g.name.toLowerCase()===name.toLowerCase());
  if(exist){
    alert("Группа с таким именем уже есть");
    return;
  }
  // Создаем локально, т.к. серверного управления нет
  const newId = "group" + (Object.keys(GROUP_DEFS).length + 1);
  GROUP_DEFS[newId] = {name, mode:"open"};
  groupIds.push(newId);
  renderSidebar();
  addGroupModal.style.display = "none";
  addGroupModal.setAttribute("aria-hidden","true");
  openGroup(newId);
};

/********************
 * 17. Splash screen text loop *
 ********************/
const splashTexts = ["лабобу", "абоба", "абоба...", "абобасервер", "Loading..."];
let splashIndex = 0;
setInterval(()=>{
  splashScreen.textContent = splashTexts[splashIndex];
  splashIndex = (splashIndex + 1) % splashTexts.length;
},1200);
</script>
</body>
</html>
